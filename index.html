<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CalcWars</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.9.0/math.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/algebrite/1.2.0/algebrite.bundle.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }
        .buttons {
            margin-top: 20px;
        }
        .unusable {
            color: #666;
            background-color: #eee;
            border: #999;
        }
        button {
            font-size: 18px;
            margin: 5px;
            padding: 10px;
        }
    </style>
</head>
<body>
    <h1>Simplify the Expression</h1>
    <div id="expression">x</div>
    <div class="buttons">
        <button onclick="applyLn()">\( \ln(x) \)</button>
        <button onclick="exponentiate()">\( e^x \)</button>
        <button onclick="differentiate()">\( \frac{d}{dx} \)</button>
        <button onclick="integrate()" id="int" class="unusable">\( \int \, dx \)</button>
        <button onclick="reciprocal()">\( \frac{1}{x} \)</button>
    </div>

    <script>
        let expr = "x ^ 100";
        updateExpression(expr);
        var prevExpr = "";
        var prevFunc = "";

        function updateExpression(newExpr) {
            expr = newExpr;

            let simplifiedExpr = math.simplify(expr).toString();
            //console.log(simplifiedExpr);

            document.getElementById("expression").innerHTML = `\\( ${math.parse(simplifiedExpr).toTex()} \\)`;
            MathJax.typesetPromise();
            checkWin();
        }

        function applyLn() {
            prevFunc = "ln";
            prevExpr = expr;

            // Check for exactly one exponentiation operation
            if ((expr.match(/\^/g) || []).length === 1) {
                // Move the exponent outside the logarithm
                let newExpr = `log(${expr.split('^')[0]}) * ${expr.split('^')[1]}`;
                updateExpression(newExpr);
            } else {
                // Just apply ln to the whole expression
                updateExpression(`log(${expr})`);
            }
        }

        function exponentiate() {
            prevFunc = "exp";
            prevExpr = expr;

            let newExpr =  `e^(${expr})`;
            updateExpression(newExpr);
        }

        function differentiate() {
            prevFunc = "dx";
            prevExpr = expr;
            document.getElementById("int").classList.remove("unusable");

            try {
                let derivative = math.derivative(expr, 'x').toString();
                updateExpression(derivative);
            } catch (error) {
                alert("Could not differentiate the expression.");
            }
        }

        function integrate() {
            if (prevFunc == "dx") {
                updateExpression(prevExpr);
            }

            prevFunc = "int";
            prevExpr = expr;
            document.getElementById("int").classList.add("unusable");

            // add an integral symbol
        }

        function reciprocal() {
            prevFunc = "recip";
            prevExpr = expr;

            let newExpr = `1 / (${expr})`;
            updateExpression(newExpr);
        }

        function checkWin() {
            if (expr === "0") {
                document.getElementById("expression").innerHTML = "ðŸŽ‰ Level complete! You reached 0! ðŸŽ‰";
            }
        }
    </script>
</body>
</html>